# TikTok Reporting API

Автоматически или через вызов метода в Rest API загрузает маркетинговые данные из API TikTok

## Setup

1. Заполнить переменные окружения в docker-compose.yml
    - **ports** - связь локального порта, с портом приложения в контейнере, eg. `10010:80`, трафик сервера на порту
      10010 будет прокидываться внутрь контейнера на порт 80
    - **API_ENDPOINT** - хост и порт приложения внутри контейнера, eg. `0.0.0.0:1234`, тогда в ports нужно будет
      указать `10010:1234`
    - **TIKTOK_APP_ID** - идентификатор приложения в tiktok
    - **TIKTOK_APP_SECRET** - секрет приложения в tiktok
    - **TIKTOK_APP_TOKEN** - активный токен в tiktok, если уже есть
    - **BQ_PROJECT_ID** - идентификатор приложения в google bigquery
    - **BQ_DATASET_ID** - название датасета в google bigquery
    - **BQ_AUC_TABLE_ID** - название таблицы для данных по аукционам в google bigquery
    - **BQ_RES_TABLE_ID** - название таблицы для данных по резервации в google bigquery
    - **JOB_INTERVAL_HOURS** - с какой периодичностью запускать джобу, в часах
    - **STATISTIC_DEPTH_DAYS** - с какой глубиной запрашивать данные, в днях, eg. 7 - означает за последние 7 дней
2. Заполнить файл `credentials.json` в папке `configs/`
3. Если есть конкретный список `advertising_ids`, то можно положить его в файл `advert_ids.txt` в папке `configs/`
   каждый на отдельной строке. На старте, приложение считает айдишники из файла и будет собирать статистику по ним. **
   Вызов колбека перезатрет айдишники из файла.**

## Run

1. Выполнить команду `docker compose up -d` в корневой директории проекта
2. Привязать колбек авторизации `0.0.0.0:80/auth/callback` (заменить 0.0.0.0:80 на свой домен/хост-порт) в ЛК тиктока

## Usage

В сервисе джоба запускается с заданным интервалом, берет айдишники, полученные либо из файла при старте, либо из ответа
в колбеке авторизации, получает данные из API тиктока и записывает в две таблицы в bigquery, по аукциону и резервации.  
Можно запускать джобу несколько раз в день и за прошлые даты, более свежая статистика перезатрет старую.  
Можно получить статистику по конкретной кампании за указанный период вызовом методов апи: `/report/auction`
и `/report/reservation`,
пример: `http://localhost:80/report/auction?advertiser_id=123456789&start_date=2021-09-29&end_date=2021-10-29`  
Данные по кампании вернуться в ответе и будут записаны в bigquery
